<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title></title>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/custom.css" rel="stylesheet">
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col-12" id="currentValueWrapper">Current value: <span id="lastValue">-</span><div>Own current value: <input id="ownCurrentValue"/></div></div>
      <div class="form-group col-xs-12 col-md-6">
        <label for="boughtFor">Bought for price:</label>
        <input type="text" class="form-control" id="boughtFor" value="5850">
      </div>
      <div class="form-group col-xs-12 col-md-6">
        <label for="tradeFee">Trade fee in %:</label>
        <input type="text" class="form-control" id="tradeFee" value="0.25">
      </div>
      <div class="form-group col-xs-12 col-md-6">
        <label for="euroAmount">EURO amount in:</label>
        <input type="text" class="form-control" id="euroAmountIn" value="1652.21">
      </div>
      <div class="form-group col-xs-12 col-md-6">
        <label for="euroAmount">BTC:</label>
        <input type="text" class="form-control" id="btcAmount" disabled="true">
      </div>
      <!-- <div class="form-group col-xs-12 col-md-6">
        <label for="euroAmount">BTC amount out:</label>
        <input type="text" class="form-control" id="btcAmountOut" value="0.28003390361445785">
      </div> -->
      <div class="form-group col-xs-12 col-md-6">
        <label for="tradeFee">Payout:</label>
        <input type="text" class="form-control" id="returnValue" disabled="true">
      </div>
      <div class="form-group col-xs-12 col-md-6">
        <label for="tradeFee">Result in â‚¬:</label>
        <input type="text" class="form-control" id="returnResult" disabled="true">
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <span class="text-muted">Developed within 1 hour. Sourcecode: <a href="https://github.com/timhaag/daily/tree/master/experimental/socket.io-framework" target="_blank">GitHub</a> Creator:<a href="https://timhaag.de/" target="_blank">Tim Haag</a></span>
    </div>
  </footer>

  <script src="/js/jquery.slim.min.js"></script>
  <script src="/js/tether.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  <script src="/js/socket.io.js"></script>
  <script type="text/javascript">
    var socket = io('http://localhost:3000')

    $(document).on('keyup', '#ownCurrentValue', () => {
      go($('#ownCurrentValue').val())
    })

    socket.on('newPrice', data => {
      document.title = data.last

      let currentPrice = data.last;

      if($('#ownCurrentValue').val().length > 0) {
        currentPrice = $('#ownCurrentValue').val()
      }

      go(currentPrice)

    })

    function go(currentPrice) {
      let euroAmountIn = $('#euroAmountIn').val()
      // let btcAmountOut = $('#btcAmountOut').val()
      let boughtFor = $('#boughtFor').val()
      let tradeFee = $('#tradeFee').val()

      euroAmountIn -= euroAmountIn / 100 * tradeFee

      let btcAmount = 1 / (boughtFor / euroAmountIn)
      $('#btcAmount').val(btcAmount)

      let priceDiffPercent = 100 - (100 / currentPrice * boughtFor);

      let returnValue = 0;
      if (priceDiffPercent > 0) {
        returnValue = euroAmountIn + (euroAmountIn / 100 * priceDiffPercent)
      } else if (priceDiffPercent < 0) {
        returnValue = euroAmountIn - (euroAmountIn / 100 * (priceDiffPercent * (-1)))
      }

      returnValue -= returnValue / 100 * tradeFee
      $('#returnValue').val(returnValue)

      $('#returnResult').val(returnValue - $('#euroAmountIn').val())

      $('#lastValue').html(currentPrice)
    }
  </script>
</body>

</html>
